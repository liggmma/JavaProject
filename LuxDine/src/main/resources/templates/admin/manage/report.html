<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Báo cáo & Thống kê | LuxDine Admin</title>

        <!-- Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Inter font -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --primary: #0a0a23;
                --accent: #f97316;
                --secondary: #3b82f6;
                --bg: #f9fafb;
                --white: #ffffff;
                --border: #e5e7eb;
                --muted: #6b7280;
                --success: #22c55e;
                --warning: #facc15;
                --error: #ef4444;
                --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
                --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.1);
                --radius: 12px;
                --radius-sm: 8px;
            }

            * {
                box-sizing: border-box;
            }
            body {
                font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto,
                    "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
                    "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji",
                    sans-serif;
                margin: 0;
                color: var(--primary);
                background: var(--bg);
                line-height: 1.5;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 24px;
            }
            h1 {
                font-size: 32px;
                font-weight: 700;
                margin: 0 0 28px;
                display: flex;
                align-items: center;
                gap: 12px;
                justify-content: center;
            }

            /* Filter form */
            .date-filter {
                background: var(--white);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 24px;
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: flex-end;
                box-shadow: var(--shadow);
                margin-bottom: 28px;
            }
            .filter-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
                min-width: 180px;
                flex: 1;
            }
            .filter-group label {
                font-weight: 600;
                font-size: 14px;
            }
            select,
            input[type="number"] {
                height: 44px;
                border: 1px solid var(--border);
                border-radius: var(--radius-sm);
                padding: 0 14px;
                font-size: 14px;
                background: var(--white);
                transition: border-color 0.2s, box-shadow 0.2s;
            }
            select:focus,
            input[type="number"]:focus {
                outline: none;
                border-color: var(--primary);
                box-shadow: 0 0 0 3px rgba(10, 10, 35, 0.1);
            }

            .btn-group {
                display: flex;
                gap: 12px;
                align-items: center;
            }
            .btn {
                height: 44px;
                padding: 0 18px;
                border-radius: var(--radius-sm);
                display: inline-flex;
                align-items: center;
                gap: 8px;
                font-weight: 600;
                text-decoration: none;
                cursor: pointer;
                border: none;
                background: var(--accent);
                color: #fff;
                transition: transform 0.15s ease, box-shadow 0.15s ease,
                    background 0.15s;
            }
            .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 6px 16px rgba(249, 115, 22, 0.3);
                background: #ea580c;
            }
            .btn:active {
                transform: translateY(0);
            }
            .btn-secondary {
                background: var(--primary);
            }
            .btn-secondary:hover {
                background: #14143a;
                box-shadow: 0 6px 16px rgba(10, 10, 35, 0.25);
            }
            .btn-pdf {
                background: #dc2626;
            }
            .btn-pdf:hover {
                background: #b91c1c;
                box-shadow: 0 6px 16px rgba(220, 38, 38, 0.3);
            }
            .btn-excel {
                background: #15803d;
            }
            .btn-excel:hover {
                background: #166534;
                box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
            }

            /* Stats */
            .stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
                gap: 18px;
                margin-bottom: 28px;
            }
            .card {
                background: var(--white);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 20px;
                box-shadow: var(--shadow);
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .card:hover {
                transform: translateY(-4px);
                box-shadow: var(--shadow-lg);
            }
            .card h3 {
                margin: 0 0 8px;
                font-size: 13px;
                text-transform: uppercase;
                color: var(--muted);
                letter-spacing: 0.5px;
            }
            .card .value {
                margin: 0;
                font-size: 28px;
                font-weight: 700;
                color: var(--primary);
                word-break: break-word;
            }

            /* Chart block */
            .chart-container {
                background: var(--white);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 22px;
                box-shadow: var(--shadow);
                margin-bottom: 24px;
            }
            .chart-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 12px;
                margin-bottom: 14px;
            }
            .chart-title {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
            }
            .chart-actions {
                display: flex;
                gap: 10px;
            }
            .chart-action-btn {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 8px 14px;
                border-radius: 8px;
                background: var(--bg);
                border: 1px solid var(--border);
                color: var(--primary);
                text-decoration: none;
                cursor: pointer;
                transition: background 0.15s, color 0.15s, border-color 0.15s;
            }
            .chart-action-btn:hover {
                background: var(--primary);
                color: #fff;
                border-color: var(--primary);
            }
            canvas {
                width: 100% !important;
                max-height: 400px;
            }

            /* Table */
            .table-container {
                background: var(--white);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                overflow: hidden;
            }
            table {
                width: 100%;
                border-collapse: collapse;
            }
            thead th {
                background: var(--primary);
                color: #fff;
                padding: 14px 18px;
                font-size: 13px;
                text-transform: uppercase;
                letter-spacing: 0.4px;
                text-align: left;
            }
            tbody td {
                padding: 14px 18px;
                border-bottom: 1px solid var(--border);
            }
            tbody tr:hover td {
                background: rgba(249, 115, 22, 0.05);
            }
            .empty-state {
                text-align: center;
                color: var(--muted);
                padding: 24px;
            }

            /* Mode groups */
            .mode-dependent {
                display: none;
            }

            /* Loading */
            .loading {
                display: none;
                text-align: center;
                color: var(--muted);
                padding: 10px 0 18px;
            }
            .loading-spinner {
                width: 28px;
                height: 28px;
                border-radius: 50%;
                border: 3px solid #e5e7eb;
                border-top-color: var(--accent);
                animation: spin 1s linear infinite;
                margin: 0 auto 10px;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Responsive */
            @media (max-width: 768px) {
                .date-filter {
                    flex-direction: column;
                    align-items: stretch;
                }
                .filter-group {
                    min-width: 100%;
                }
                .chart-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 12px;
                }
            }
        </style>

        <!-- (Tuỳ dự án) chèn styles chung của admin -->
        <th:block
            th:replace="~{admin/fragments/admin-header :: adminStyles}"
        ></th:block>
    </head>
    <body>
        <!-- (Tuỳ dự án) header chung -->
        <th:block
            th:replace="~{admin/fragments/admin-header :: adminHeader}"
        ></th:block>

        <div class="container">
            <h1>Báo cáo & Thống kê</h1>

            <!-- Filter -->
            <form
                method="get"
                action="/admin/report"
                class="date-filter"
                id="filterForm"
            >
                <div class="filter-group">
                    <label for="mode">Chế độ xem</label>
                    <select name="mode" id="mode" onchange="toggleFilters()">
                        <option value="week" th:selected="${mode == 'week'}">
                            Tuần
                        </option>
                        <option value="month" th:selected="${mode == 'month'}">
                            Tháng
                        </option>
                        <option
                            value="quarter"
                            th:selected="${mode == 'quarter'}"
                        >
                            Quý
                        </option>
                        <option value="year" th:selected="${mode == 'year'}">
                            Năm
                        </option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="year">Năm</label>
                    <input
                        type="number"
                        name="year"
                        id="year"
                        min="2020"
                        th:value="${year}"
                    />
                </div>

                <div class="filter-group mode-dependent" id="monthGroup">
                    <label for="month">Tháng</label>
                    <input
                        type="number"
                        name="month"
                        id="month"
                        min="1"
                        max="12"
                        th:value="${month}"
                    />
                </div>

                <div class="filter-group mode-dependent" id="weekGroup">
                    <label for="weekNumber">Tuần</label>
                    <select name="weekNumber" id="weekNumber">
                        <option
                            th:each="i : ${#numbers.sequence(1,5)}"
                            th:value="${i}"
                            th:text="'Tuần ' + ${i}"
                            th:selected="${i == weekNumber}"
                        ></option>
                    </select>
                </div>

                <div class="filter-group mode-dependent" id="quarterGroup">
                    <label for="quarter">Quý</label>
                    <select name="quarter" id="quarter">
                        <option
                            th:each="q : ${#numbers.sequence(1,4)}"
                            th:value="${q}"
                            th:text="'Quý ' + ${q}"
                            th:selected="${q == quarter}"
                        ></option>
                    </select>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn">Xem báo cáo</button>

                    <!-- Export PDF -->
                    <a
                        th:href="@{/admin/report/export(
                mode=${mode},
                year=${year},
                month=${mode == 'week' or mode == 'month' ? month : null},
                weekNumber=${mode == 'week' ? weekNumber : null},
                quarter=${mode == 'quarter' ? quarter : null},
                type='pdf'
             )}"
                        class="btn btn-pdf export-link"
                        >Xuất PDF</a
                    >

                    <!-- Export Excel -->
                    <a
                        th:href="@{/admin/report/export(
                mode=${mode},
                year=${year},
                month=${mode == 'week' or mode == 'month' ? month : null},
                weekNumber=${mode == 'week' ? weekNumber : null},
                quarter=${mode == 'quarter' ? quarter : null},
                type='excel'
             )}"
                        class="btn btn-excel export-link"
                        >Xuất Excel</a
                    >
                </div>
            </form>

            <!-- Loading -->
            <div class="loading" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <div>Đang tạo file xuất...</div>
            </div>

            <!-- Stats -->
            <div class="stats">
                <div class="card">
                    <h3>Doanh thu</h3>
                    <p
                        class="value"
                        th:text="${#numbers.formatDecimal(report.totalRevenue, 1, 'COMMA', 0, 'POINT')} + ' đ'"
                    ></p>
                </div>
                <div class="card">
                    <h3>Đơn hàng</h3>
                    <p class="value" th:text="${report.totalOrders}"></p>
                </div>
                <div class="card">
                    <h3>Đơn hủy</h3>
                    <p
                        class="value"
                        th:text="${report.totalCancelledOrders}"
                    ></p>
                </div>
                <div class="card">
                    <h3>Hoàn tiền</h3>
                    <p
                        class="value"
                        th:text="${report.totalRefundedPayments}"
                    ></p>
                </div>
                <div class="card">
                    <h3>Bàn đặt</h3>
                    <p
                        class="value"
                        th:text="${report.totalReservedTables}"
                    ></p>
                </div>
                <div class="card">
                    <h3>Nhân viên</h3>
                    <p class="value" th:text="${report.totalStaff}"></p>
                </div>
                <div class="card">
                    <h3>Người dùng</h3>
                    <p class="value" th:text="${report.totalUsers}"></p>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3
                        class="chart-title"
                        th:text="${mode == 'year'} ? 'Doanh thu theo tháng - Năm ' + ${year}
              : (${mode == 'quarter'} ? 'Doanh thu theo tháng - Quý ' + ${quarter} + ' năm ' + ${year}
              : (${mode == 'month'} ? 'Doanh thu theo ngày - Tháng ' + ${month} + '/' + ${year}
              : 'Doanh thu - Tuần ' + ${weekNumber} + ' Tháng ' + ${month} + '/' + ${year}))"
                    ></h3>
                    <div class="chart-actions">
                        <button
                            type="button"
                            class="chart-action-btn"
                            onclick="toggleChartType()"
                        >
                            Đổi dạng biểu đồ
                        </button>
                    </div>
                </div>
                <canvas id="revenueChart"></canvas>
            </div>

            <!-- Top items -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Tên món</th>
                            <th>Số lượng bán</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${report.top5Items}">
                            <td th:text="${item.name}"></td>
                            <td th:text="${item.totalSold}"></td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(report.top5Items)}">
                            <td class="empty-state" colspan="2">
                                Chưa có dữ liệu
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inline JS để dùng biến Thymeleaf -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            let currentChartType = "bar";

            function toggleFilters() {
                const mode = document.getElementById("mode").value;
                const monthGroup = document.getElementById("monthGroup");
                const weekGroup = document.getElementById("weekGroup");
                const quarterGroup = document.getElementById("quarterGroup");

                monthGroup.style.display = "none";
                weekGroup.style.display = "none";
                quarterGroup.style.display = "none";

                if (mode === "month") monthGroup.style.display = "flex";
                if (mode === "week") {
                    monthGroup.style.display = "flex";
                    weekGroup.style.display = "flex";
                }
                if (mode === "quarter") quarterGroup.style.display = "flex";
            }

            function toggleChartType() {
                currentChartType = currentChartType === "bar" ? "line" : "bar";
                renderChart();
            }

            function showLoading() {
                const e = document.getElementById("loadingIndicator");
                if (e) {
                    e.style.display = "block";
                    setTimeout(() => (e.style.display = "none"), 6000);
                }
            }
            function hideLoading() {
                const e = document.getElementById("loadingIndicator");
                if (e) e.style.display = "none";
            }

            function attachExportGuards() {
                // Nếu không có report thì cấm export
                const hasData = /*[[${report != null}]]*/ false;
                const links = document.querySelectorAll(".export-link");
                links.forEach((a) => {
                    a.addEventListener("click", (evt) => {
                        if (!hasData) {
                            evt.preventDefault();
                            alert(
                                "Không có dữ liệu để xuất. Vui lòng xem báo cáo trước."
                            );
                            return;
                        }
                        showLoading();
                    });
                });
                window.addEventListener("pageshow", hideLoading);
            }

            let revenueChartInstance = null;
            function renderChart() {
                const ctx = document
                    .getElementById("revenueChart")
                    .getContext("2d");
                const revMap = /*[[${report.revenueByDate}]]*/ {};
                const labels = Object.keys(revMap || {});
                const series = Object.values(revMap || {});

                if (revenueChartInstance) revenueChartInstance.destroy();

                revenueChartInstance = new Chart(ctx, {
                    type: currentChartType,
                    data: {
                        labels,
                        datasets: [
                            {
                                label: "Doanh thu (VND)",
                                data: series,
                                backgroundColor:
                                    currentChartType === "bar"
                                        ? "rgba(249,115,22,0.28)"
                                        : "transparent",
                                borderColor: "#F97316",
                                borderWidth: 2,
                                fill: currentChartType === "line",
                                tension: 0.35,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) =>
                                        new Intl.NumberFormat("vi-VN").format(
                                            ctx.raw
                                        ) + " đ",
                                },
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (v) =>
                                        new Intl.NumberFormat("vi-VN", {
                                            notation: "compact",
                                            maximumFractionDigits: 1,
                                        }).format(v) + " đ",
                                },
                                grid: { color: "rgba(0,0,0,.06)" },
                            },
                            x: { grid: { display: false } },
                        },
                    },
                });
            }

            document.addEventListener("DOMContentLoaded", () => {
                toggleFilters();
                renderChart();
                attachExportGuards();
            });
            /*]]>*/
        </script>
    </body>
</html>
