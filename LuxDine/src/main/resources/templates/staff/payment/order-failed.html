<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width,initial-scale=1" name="viewport"/>
    <title>Thanh toán thất bại — LuxDine</title>

    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <style>
        :root {
            --color-primary: #0A0A23;
            --color-bg: #F9FAFB;
            --color-surface: #FFFFFF;
            --color-border: #E5E7EB;
            --color-text: #111827;
            --color-text-muted: #6B7280;
            --error-bg: #FEF2F2;
            --error-fg: #991B1B;
            --error-br: #FCA5A5;
            --radius: 12px;
            --btn-radius: 10px;
            --shadow: 0 1px 2px rgba(0, 0, 0, .05);
            --container: 1080px;
            --space-1: 8px;
            --space-2: 12px;
            --space-3: 16px;
            --space-4: 24px;
            --space-5: 32px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text)
        }

        .container {
            max-width: var(--container);
            margin: 0 auto;
            padding: var(--space-5) var(--space-3)
        }

        /* Hero */
        .hero {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px
        }

        .pill-error {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: var(--error-bg);
            color: var(--error-fg);
            border: 1px solid var(--error-br);
            font-weight: 700
        }

        .subtle {
            color: var(--color-text-muted);
            font-size: 14px
        }

        /* Grid */
        .grid {
            display: grid;
            gap: var(--space-4)
        }

        @media (min-width: 900px) {
            .grid {
                grid-template-columns:2fr 1fr
            }
        }

        /* Card */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: var(--space-4)
        }

        h1 {
            font-size: 28px;
            margin: 0
        }

        h2 {
            font-size: 20px;
            margin: 0 0 8px
        }

        .kv {
            display: grid;
            grid-template-columns:1fr auto;
            gap: 10px 16px
        }

        .kv dt {
            color: var(--color-text-muted)
        }

        .kv dd {
            margin: 0;
            font-weight: 600
        }

        .mono {
            font-variant-numeric: tabular-nums
        }

        /* Buttons */
        .actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: var(--space-4)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 42px;
            padding: 0 16px;
            border-radius: var(--btn-radius);
            border: 1px solid transparent;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none
        }

        .btn-primary {
            background: var(--color-primary);
            color: #fff
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid var(--color-border);
            color: #111827
        }

        /* Pretty (but minimal) select */
        .select {
            width: 100%;
            height: 44px;
            padding: 0 12px;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            background: #fff;
            outline: none; /* giữ caret mặc định của hệ điều hành (không icon tùy biến) */
            font-weight: 600;
            box-shadow: var(--shadow)
        }

        .select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(10, 10, 35, .10)
        }
    </style>
</head>
<body>
<main class="container">

    <!-- HERO -->
    <div class="hero">
        <span class="pill-error">Thanh toán thất bại</span>
        <div class="subtle">
            Đơn #<b th:text="${order.id}">0</b>
            <span th:if="${payment != null}"> · Lúc <span
                    th:text="${#dates.format(payment.createdDate, 'dd/MM/yyyy HH:mm')}">—</span></span>
        </div>
    </div>

    <section class="grid">
        <!-- LEFT -->
        <article class="card">
            <h2>Không thể hoàn tất thanh toán</h2>
            <p class="subtle" style="margin:6px 0 14px">
        <span th:text="${errorMessage != null ? errorMessage : 'Giao dịch không thành công. Vui lòng thử lại hoặc chọn phương thức khác.'}">
          Giao dịch không thành công. Vui lòng thử lại hoặc chọn phương thức khác.
        </span>
            </p>

            <dl class="kv" style="margin-top:8px">
                <dt>Order ID</dt>
                <dd class="mono" th:text="${order.id}">0</dd>

                <dt>Payment ID</dt>
                <dd class="mono" th:text="${payment != null ? payment.id : '—'}">—</dd>

                <dt>Transaction ID</dt>
                <dd class="mono"
                    th:text="${payment != null && payment.transactionId != null ? payment.transactionId : '—'}">—
                </dd>

                <dt>Phương thức</dt>
                <dd th:text="${payment != null ? payment.method : '—'}">—</dd>

                <dt>Trạng thái</dt>
                <dd th:text="${payment != null ? payment.status : 'FAILED'}">FAILED</dd>

                <dt>Thời gian</dt>
                <dd class="mono"
                    th:text="${payment != null ? #dates.format(payment.createdDate, 'dd/MM/yyyy HH:mm') : #dates.format(#dates.createNow(), 'dd/MM/yyyy HH:mm')}">
                    —
                </dd>

                <dt>Số tiền cần thanh toán</dt>
                <dd class="mono">
          <span data-amount
                th:attr="data-amount=${order.amountDue != null ? order.amountDue : (order.subTotal - order.discountTotal + order.tax + order.serviceCharge - order.depositApplied)}">
            0 VND
          </span>
                </dd>
            </dl>
        </article>

        <!-- RIGHT -->
        <aside class="card">
            <h2>Thử lại thanh toán</h2>
            <form id="retryForm" method="post" style="margin-top:12px" th:action="@{/payment/order}">
                <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
                <input name="orderId" th:value="${order.id}" type="hidden"/>
                <!-- giữ nguyên giảm giá: đúng tên field DTO hiện tại -->
                <input name="discounted" th:value="${order.discountTotal != null ? order.discountTotal : 0}"
                       type="hidden"/>

                <label class="subtle" for="method" style="display:block;margin-bottom:6px">Chọn phương thức khác</label>
                <select class="select" id="method" name="paymentMethod" required>
                    <option disabled selected value="">-- Chọn phương thức --</option>
                    <option value="CASH">Tiền mặt</option>
                    <option value="QR">QR/Chuyển khoản</option>
                </select>

                <div class="actions">
                    <a class="btn btn-ghost" th:href="@{/staff/orders}">Về danh sách</a>
                    <a class="btn btn-ghost" th:href="@{|/staff/orders/${order.id}|}">Xem đơn</a>
                    <button class="btn btn-primary" id="retryBtn" type="submit">Thử lại</button>
                </div>
            </form>
        </aside>
    </section>
</main>

<script>
    // Định dạng tiền VND
    function formatPriceVND(price) {
        return new Intl.NumberFormat('vi-VN').format(Math.round(Number(price) || 0)) + ' VND';
    }

    function applyMoney() {
        document.querySelectorAll('[data-amount]').forEach(el => {
            el.textContent = formatPriceVND(el.getAttribute('data-amount'));
        });
    }

    document.addEventListener('DOMContentLoaded', applyMoney);
</script>
</body>
</html>
