<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>H·ªì s∆° ‚Äî LuxDine</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

    <style>
        :root {
            --color-primary: #0A0A23;
            --color-secondary: #F97316;
            --color-bg: #F9FAFB;
            --color-surface: #FFFFFF;
            --color-border: #E5E7EB;
            --color-text: #111827;
            --color-text-muted: #6B7280;
            --color-success: #22C55E;
            --color-warning: #F59E0B;
            --color-error: #EF4444;

            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-card: 0 1px 2px rgba(0, 0, 0, .05);
            --shadow-elev: 0 6px 24px rgba(0, 0, 0, .08);

            --space-2: 4px;
            --space-3: 8px;
            --space-4: 12px;
            --space-5: 16px;
            --space-6: 20px;
            --space-7: 24px;
            --space-8: 32px;
            --space-9: 40px;
            --space-10: 48px;
            --space-12: 64px;

            --font: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            --h1-size: 32px;
            --h1-lh: 1.25;
            --h1-w: 800;
            --h2-size: 22px;
            --h2-lh: 1.3;
            --h2-w: 700;
            --h3-size: 18px;
            --h3-lh: 1.4;
            --h3-w: 600;

            --container: 1200px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: var(--font);
            color: var(--color-text);
            background: linear-gradient(180deg, #fff 0%, var(--color-bg) 100%);
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        img {
            max-width: 100%;
            display: block;
        }

        .container {
            max-width: var(--container);
            margin: 0 auto;
            padding: 0 var(--space-7);
        }

        .page-title {
            font-size: var(--h1-size);
            font-weight: var(--h1-w);
            margin: var(--space-8) 0 var(--space-6);
            color: var(--color-primary);
        }

        .layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--space-8);
            align-items: start;
        }

        @media (max-width: 980px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        /* Sidebar */
        .sidebar {
            position: sticky;
            top: 80px;
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .side__head {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .side__avatar {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: var(--color-primary);
            color: #fff;
            display: grid;
            place-items: center;
            font-weight: 800;
        }

        .side__name {
            font-weight: 700;
        }

        .side__nav {
            padding: 8px;
            display: grid;
            gap: 6px;
        }

        .side__link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--color-text);
            border: 1px solid transparent;
            font-weight: 600;
        }

        .side__link:hover {
            background: #F9FAFB;
            border-color: var(--color-border);
        }

        .side__link.active {
            background: #FFF7ED;
            border-color: #FED7AA;
            color: #9A3412;
        }

        /* Cards / Forms */
        .card {
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }

        .card__head {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            font-weight: 700;
        }

        .card__body {
            padding: 20px;
            display: grid;
            gap: 16px;
        }

        .hint {
            color: var(--color-text-muted);
            font-size: 14px;
        }

        /* View rows */
        .vrow {
            display: grid;
            grid-template-columns: 180px 1fr auto;
            gap: 12px;
            align-items: center;
            padding: 8px 0;
        }

        .vrow__label {
            font-weight: 600;
            color: #111827;
        }

        .vrow__value {
            color: #374151;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            background: #fff;
            cursor: pointer;
            font-weight: 600;
            transition: .2s box-shadow, .02s transform, .2s background, .2s color
        }

        .btn:active {
            transform: translateY(1px);
        }

        /* CH·ªà √°p d·ª•ng hover n·ªÅn s√°ng cho n√∫t th∆∞·ªùng */
        .btn:not(.btn--primary):hover {
            background: #F3F4F6;
        }

        /* N√∫t ch√≠nh lu√¥n n·ªÅn ƒë·∫≠m, ch·ªØ tr·∫Øng khi hover */
        .btn--primary {
            background: var(--color-primary);
            color: #fff;
            border-color: var(--color-primary);
        }

        .btn--primary:hover {
            background: var(--color-primary);
            color: #fff;
            box-shadow: 0 6px 18px rgba(10, 10, 35, .25);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            place-items: center;
            background: rgba(0, 0, 0, .35);
            z-index: 50;
            padding: 16px;
        }

        .modal.is-open {
            display: grid;
        }

        .modal__dialog {
            width: min(560px, 96vw);
            background: #fff;
            border-radius: 12px;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-elev);
            overflow: hidden;
        }

        .modal__head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--color-border);
            font-weight: 700;
        }

        .modal__body {
            padding: 16px;
            display: grid;
            gap: 12px;
        }

        .modal__foot {
            padding: 12px 16px;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .input, .select, .textarea {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 10px 12px;
            font: inherit;
        }

        /* Chips (in modal) */
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: #F3F4F6;
        }

        .chip button {
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 700;
        }

        .chip-add {
            display: flex;
            gap: 8px;
        }

        .chip-add input {
            flex: 1;
        }

        .form-row {
            display: grid;
            gap: 8px
        }

        /* Resend disabled look */
        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .toast-wrap {
            position: fixed;
            top: 20px;
            right: 20px;
            display: grid;
            gap: 12px;
            z-index: 9999;
        }

        .toast {
            position: relative;
            display: grid;
            grid-template-columns:24px 1fr auto;
            align-items: start;
            gap: 12px;
            min-width: 280px;
            max-width: 420px;
            background: #fff;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            box-shadow: var(--shadow-elev);
            padding: 12px 14px;
            animation: toastIn .25s ease both;
        }

        .toast--success {
            border-left: 4px solid #22c55e;
            color: #166534;
        }

        .toast--error {
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .toast__icon {
            font-size: 18px;
            line-height: 1;
        }

        .toast__body {
            font-weight: 600;
        }

        .toast__close {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            color: inherit;
            padding: 2px 6px;
            border-radius: 8px;
        }

        .toast__close:hover {
            background: rgba(0, 0, 0, .04);
        }

        .toast__progress {
            position: absolute;
            left: 0;
            bottom: 0;
            height: 3px;
            width: 100%;
            background: currentColor;
            opacity: .25;
            animation: toastBar linear forwards;
        }

        .toast.is-hiding {
            opacity: 0;
            transform: translateY(-6px);
            transition: .2s ease;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateY(6px)
            }
            to {
                opacity: 1;
                transform: none
            }
        }

        @keyframes toastBar {
            from {
                width: 100%
            }
            to {
                width: 0%
            }
        }

        /* ==== Inline help messages (email flow) ==== */
        .help {
            font-size: 14px;
            margin-top: 6px;
            display: none;
        }

        .help-ok {
            display: block;
            color: #166534;
            background: #dcfce7;
            border: 1px solid #86efac;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .help-err {
            display: block;
            color: #991b1b;
            background: #fee2e2;
            border: 1px solid #fecaca;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .input--error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, .08);
        }

        .vrow.vrow--form {
            grid-template-columns:1fr;
            gap: 20px;
        }

        .vrow.vrow--form .field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Strength meter */
        .pw-meter {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .pw-meter .pw-bar {
            height: 8px;
            width: 36px;
            border-radius: 6px;
            background: #e5e7eb;
            display: inline-block;
        }

        .pw-meter .pw-bar.is-active.level-1 {
            background: #fca5a5;
        }

        /* y·∫øu */
        .pw-meter .pw-bar.is-active.level-2 {
            background: #fdba74;
        }

        /* trung b√¨nh */
        .pw-meter .pw-bar.is-active.level-3 {
            background: #fcd34d;
        }

        /* kh√° */
        .pw-meter .pw-bar.is-active.level-4 {
            background: #86efac;
        }

        /* m·∫°nh */
        .pw-meter .pw-label {
            font-size: 12px;
            color: #6b7280;
            margin-left: 8px;
        }

        /* Tips nh·ªè */
        .pw-tips {
            margin: 6px 0 0;
            padding-left: 18px;
            color: #6b7280;
            font-size: 13px;
            line-height: 1.6;
        }

        /* CapsLock hint */
        .help-caps {
            color: #b45309;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            padding: 6px 8px;
            border-radius: 8px;
        }

        .input-wrap {
            position: relative;
        }

        /* ===== Loyalty layout ===== */
        .loy {
            display: grid;
            gap: 16px;
        }

        .loy__top {
            display: grid;
            gap: 16px;
            grid-template-columns: 1fr 1.2fr;
        }

        @media (max-width: 980px) {
            .loy__top {
                grid-template-columns: 1fr;
            }
        }

        .loy .label {
            font-weight: 600;
            color: #111827;
        }

        .loy__stat {
            display: grid;
            gap: 14px;
            padding: 14px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: #fff;
        }

        .loy__stat-item {
            display: grid;
            gap: 6px;
        }

        .loy__tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: linear-gradient(90deg, #FFF7ED, #FFE7D4);
            border: 1px solid #FED7AA;
            color: #9A3412;
            font-weight: 700;
            width: max-content;
        }

        .loy__points {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .loy__points-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--color-primary);
        }

        .loy__points-unit {
            color: var(--color-text-muted);
        }

        /* Progress */
        .progress {
            position: relative;
            height: 12px;
            border-radius: 999px;
            background: #F3F4F6;
            border: 1px solid var(--color-border);
            overflow: hidden;
        }

        .progress__bar {
            position: relative;
            height: 100%;
            background: linear-gradient(90deg, var(--color-secondary), var(--color-primary));
            border-right: 1px solid rgba(0, 0, 0, .08);
        }

        .progress__pct {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(0, 0, 0, .25); /* gi√∫p n·ªïi tr√™n n·ªÅn */
            pointer-events: none;
        }

        .progress.is-animated .progress__bar {
            transition: width .5s cubic-bezier(.2, .8, .2, 1);
        }

        .progress__bar.is-tiny .progress__pct {
            left: calc(100% + 8px);
            right: auto;
            color: #111;
            background: #e5e7eb;
        }

        /* Tier list */
        .loy__tiers-card {
            margin-top: 8px;
        }

        .loy__tier-list {
            display: grid;
            gap: 10px;
        }

        .tier-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            background: #fff;
        }

        .tier-row[data-current="true"] {
            background: #F0F9FF;
            border-color: #BAE6FD;
        }

        .tier-row__left {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .tier-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--color-secondary);
            margin-top: 7px;
            flex: 0 0 auto;
        }

        .tier-meta {
            display: grid;
            gap: 4px;
        }

        .tier-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tier-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #F3F4F6;
            color: #374151;
            font-size: 12px;
            border: 1px solid var(--color-border);
        }

        .tier-benefit {
            line-height: 1.5;
        }

        .tier-row__right {
            display: flex;
            align-items: center;
        }

        .tag-current {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            color: #166534;
            background: #dcfce7;
            border: 1px solid #86efac;
        }
    </style>

    <!-- Fragments -->
    <th:block th:replace="~{customer/fragments/header :: styles}"></th:block>
    <th:block th:replace="~{customer/fragments/footer :: styles}"></th:block>
</head>
<body>
<th:block th:replace="~{customer/fragments/header :: header}"></th:block>
<div class="toast-wrap" id="toastWrap"></div>
<main class="container">
    <h1 class="page-title">T√†i kho·∫£n c·ªßa t√¥i</h1>

    <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar" aria-label="User navigation">
            <div class="side__head">
                <div class="side__avatar" th:text="${#strings.substring(user.username,0,1).toUpperCase()}">U</div>
                <div>
                    <div class="side__name" th:text="${user.username}">username</div>
                </div>
            </div>
            <nav class="side__nav">
                <!-- B·ªé ICON -->
                <a class="side__link" th:href="@{/profile(tab='profile')}"
                   th:classappend="${tab}=='profile' ? ' active' : ''">H·ªì s∆°</a>
                <a class="side__link" th:href="@{/profile(tab='changepass')}"
                   th:classappend="${tab}=='changepass' ? ' active' : ''">ƒê·ªïi m·∫≠t kh·∫©u</a>
                <a class="side__link" th:href="@{/profile(tab='settings')}"
                   th:classappend="${tab}=='settings' ? ' active' : ''">C√†i ƒë·∫∑t</a>
                <a class="side__link" th:href="@{/profile(tab='loyalty')}"
                   th:classappend="${tab}=='loyalty' ? ' active' : ''">Kh√°ch h√†ng th√¢n thi·∫øt</a>
            </nav>
        </aside>

        <!-- Content -->
        <section aria-live="polite">
            <!-- Profile -->
            <div class="card" th:if="${tab}=='profile'">
                <div class="card__head">H·ªì s∆°</div>
                <div class="card__body">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrfToken"/>

                    <!-- H·ªç v√† t√™n (g·ªôp) -->
                    <div class="vrow">
                        <div class="vrow__label">T√™n kh√°ch h√†ng</div>
                        <div class="vrow__value" id="valName" th:text="${name}">Nguy·ªÖn VƒÉn A</div>
                        <button class="btn" id="btnName">ƒê·ªïi</button>
                    </div>

                    <!-- Email -->
                    <div class="vrow">
                        <div class="vrow__label">Email</div>
                        <div class="vrow__value" id="valEmail" th:text="${user.email}">email@example.com</div>
                        <button class="btn" id="btnEmail">ƒê·ªïi</button>
                    </div>

                    <!-- Phone -->
                    <div class="vrow">
                        <div class="vrow__label">S·ªë ƒëi·ªán tho·∫°i</div>
                        <div class="vrow__value" id="valPhone" th:text="${user.phoneNumber}">09xx xxx xxx</div>
                        <button class="btn" id="btnPhone">ƒê·ªïi</button>
                    </div>

                    <!-- Allergens (ch·ªâ xem nhanh, ch·ªânh trong popup) -->
                    <div class="vrow">
                        <div class="vrow__label">D·ªã ·ª©ng</div>
                        <div class="vrow__value" id="valAllergens"
                             th:text="${#lists.isEmpty(user.allergens) ? '‚Äî' : #strings.listJoin(user.allergens, ', ')}">
                            ‚Äî
                        </div>
                        <button class="btn" id="btnAllergens">Th√™m</button>
                    </div>
                </div>
            </div>

            <!-- Change password -->
            <div class="card" th:if="${tab}=='changepass'">
                <div class="card__head">ƒê·ªïi m·∫≠t kh·∫©u</div>

                <!-- Kh√¥ng d√πng th:action, submit do JS /profile/password -->
                <form id="formChangePass" class="card__body" autocomplete="off">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrfToken"/>

                    <div class="vrow vrow--form">
                        <!-- Current -->
                        <div class="field">
                            <label class="vrow__label" for="currPass">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                            <div class="input-wrap">
                                <input id="currPass" class="input" type="password" name="currentPassword" required/>
                            </div>
                            <div id="capCurr" class="help"></div>
                            <div id="errCurr" class="help"></div>
                        </div>

                        <!-- New -->
                        <div class="field">
                            <label class="vrow__label" for="newPass">M·∫≠t kh·∫©u m·ªõi</label>
                            <div class="input-wrap">
                                <input id="newPass" class="input" type="password" name="newPassword" minlength="7"
                                       required/>
                            </div>

                            <!-- Strength meter -->
                            <div class="pw-meter" id="pwMeter">
                                <span class="pw-bar"></span>
                                <span class="pw-bar"></span>
                                <span class="pw-bar"></span>
                                <span class="pw-bar"></span>
                                <span class="pw-label" id="pwLabel">ƒê·ªô m·∫°nh: ‚Äî</span>
                            </div>

                            <ul class="pw-tips">
                                <li>T·ªëi thi·ªÉu 7 k√Ω t·ª±</li>
                            </ul>

                            <div id="errNew" class="help"></div>
                        </div>

                        <!-- Confirm -->
                        <div class="field">
                            <label class="vrow__label" for="confirmPass">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                            <div class="input-wrap">
                                <input id="confirmPass" class="input" type="password" name="confirmPassword"
                                       minlength="7" required/>
                            </div>
                            <div id="errConfirm" class="help"></div>
                        </div>
                    </div>

                    <div style="display:flex;justify-content:flex-end;gap:12px">
                        <button type="submit" id="btnChangePass" class="btn btn--primary" disabled>ƒê·ªïi m·∫≠t kh·∫©u</button>
                    </div>
                </form>
            </div>

            <!-- Settings (gi·ªØ nguy√™n) -->
            <div class="card" th:if="${tab}=='settings'">
                <div class="card__head">C√†i ƒë·∫∑t</div>
                <form class="card__body" th:action="@{/profile/settings}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="vrow" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label class="hint">Th√¥ng b√°o Email</label>
                            <select class="select" name="emailNotify">
                                <option value="ALL">T·∫•t c·∫£</option>
                                <option value="IMPORTANT">Quan tr·ªçng</option>
                                <option value="NONE">T·∫Øt</option>
                            </select>
                        </div>
                        <div>
                            <label class="hint">Th√¥ng b√°o SMS</label>
                            <select class="select" name="smsNotify">
                                <option value="RESERVATIONS">Ch·ªâ l·ªãch ƒë·∫∑t b√†n</option>
                                <option value="ALL">T·∫•t c·∫£</option>
                                <option value="NONE">T·∫Øt</option>
                            </select>
                        </div>
                        <div>
                            <label class="hint">Ng√¥n ng·ªØ</label>
                            <select class="select" name="lang">
                                <option value="vi">Ti·∫øng Vi·ªát</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div>
                            <label class="hint">Giao di·ªán</label>
                            <select class="select" name="theme">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;justify-content:flex-end;">
                        <button type="submit" class="btn btn--primary">L∆∞u c√†i ƒë·∫∑t</button>
                    </div>
                </form>
            </div>

            <!-- Loyalty (gi·ªØ nguy√™n) -->
            <div class="card" th:if="${tab}=='loyalty'">
                <div class="card__head">Th√†nh vi√™n & T√≠ch ƒëi·ªÉm</div>
                <div class="card__body loy">
                    <div class="loy__top">
                        <!-- C·ªôt tr√°i: Tier & Points -->
                        <section class="loy__stat">
                            <div class="loy__stat-item">
                                <span class="label">C·∫•p hi·ªán t·∫°i</span>
                                <div class="loy__tier-badge"
                                     th:text="${user.vipTier != null ? user.vipTier.tierName : 'Standard'}">Standard
                                </div>
                            </div>
                            <div class="loy__stat-item">
                                <span class="label">ƒêi·ªÉm th∆∞·ªüng</span>
                                <div class="loy__points">
                                    <strong class="loy__points-value" th:text="${user.rewardPoints}">0</strong>
                                    <span class="loy__points-unit">ƒëi·ªÉm</span>
                                </div>
                            </div>
                        </section>

                        <!-- C·ªôt ph·∫£i: Progress l√™n h·∫°ng -->
                        <section class="loy__progress">
                            <div class="label">Ti·∫øn ƒë·ªô l√™n h·∫°ng</div>
                            <div class="progress is-animated" aria-label="Tier progress">
                                <div class="progress__bar"
                                     th:classappend="${progress.progressPct} < 10 ? ' is-tiny' : ''"
                                     th:style="|width:${progress.progressPct}%|"
                                     role="progressbar"
                                     th:attr="aria-valuenow=${progress.progressPct},aria-valuemin=0,aria-valuemax=100">
                                    <div class="progress__pct" th:text="|${progress.progressPct}%|">0%</div>
                                </div>
                            </div>

                            <div class="hint" style="margin-top:6px;">
  <span th:if="${progress.nextTierName != null}"
        th:text="|C√≤n ${progress.remainingToNext} ƒëi·ªÉm ƒë·ªÉ ƒë·∫°t ${progress.nextTierName}|"></span>
                                <span th:if="${progress.nextTierName == null}">
    B·∫°n ƒëang ·ªü h·∫°ng cao nh·∫•t. üéâ
  </span>
                            </div>


                        </section>
                    </div>

                    <!-- B·∫£ng h·∫°ng -->
                    <section class="loy__tiers">
                        <div class="label" style="margin-bottom:6px;">B·∫£ng h·∫°ng</div>
                        <div class="hint">C√°c m·ªëc ƒëi·ªÉm & quy·ªÅn l·ª£i:</div>

                        <div class="card loy__tiers-card">
                            <div class="card__body loy__tier-list">
                                <div class="tier-row"
                                     th:each="t : ${vipTiers}"
                                     th:attr="data-current=${user.vipTier != null ? user.vipTier.id == t.id : false}">
                                    <div class="tier-row__left">
                                        <span class="tier-dot" aria-hidden="true"></span>
                                        <div class="tier-meta">
                                            <div class="tier-name">
                                                <strong th:text="${t.tierName}">Tier</strong>
                                                <span class="tier-pill"
                                                      th:text="${t.requiredPoints} + ' pts'">0 pts</span>
                                            </div>
                                            <div class="tier-benefit hint" th:text="${t.benefits}">∆Øu ƒë√£i‚Ä¶</div>
                                        </div>
                                    </div>
                                    <div class="tier-row__right"
                                         th:if="${user.vipTier != null and user.vipTier.id == t.id}">
                                        <span class="tag-current">Hi·ªán t·∫°i</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- CTA -->
                    <div class="actions" style="margin-top:8px;">
                        <a th:href="@{/menu}" class="btn btn--secondary">Xem ∆∞u ƒë√£i √°p d·ª•ng</a>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!-- Modals -->
<div class="modal" id="modal-name" role="dialog" aria-modal="true" aria-labelledby="title-name">
    <div class="modal__dialog">
        <div class="modal__head">
            <span id="title-name">ƒê·ªïi t√™n hi·ªÉn th·ªã</span>
            <button class="btn" data-close="#modal-name">‚úï</button>
        </div>
        <div class="modal__body">
            <label class="hint" for="inpFullName">H·ªç v√† t√™n</label>
            <input id="inpFullName" class="input" placeholder="Nh·∫≠p h·ªç v√† t√™n m·ªõi"/>
        </div>
        <div class="modal__foot">
            <button class="btn" data-close="#modal-name">H·ªßy</button>
            <button class="btn btn--primary" id="saveName">Save</button>
        </div>
    </div>
</div>

<div class="modal" id="modal-email" role="dialog" aria-modal="true" aria-labelledby="title-email">
    <div class="modal__dialog">
        <div class="modal__head">
            <span id="title-email">ƒê·ªïi email</span>
            <button class="btn" data-close="#modal-email">‚úï</button>
        </div>

        <div class="modal__body">
            <!-- STEP 1: nh·∫≠p email -->
            <div id="emailStepStart" class="form-row">
                <label class="hint" for="inpEmail">Email m·ªõi</label>
                <input id="inpEmail" type="email" class="input" placeholder="you@example.com"/>

                <!-- NEW: current password -->
                <label class="hint" for="inpEmailCurrPw" style="margin-top:10px">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                <input id="inpEmailCurrPw" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                <div id="emailCurrPwErr" class="help"></div>

                <div id="emailStartErr" class="help"></div>
            </div>

            <!-- STEP 2: x√°c th·ª±c OTP -->
            <div id="emailStepVerify" style="display:none">
                <div class="form-row" style="margin-top:10px">
                    <label class="hint" for="inpEmailOtp">Nh·∫≠p m√£ OTP</label>
                    <input id="inpEmailOtp" class="input" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                    <div class="help" id="emailOtpStatus"></div>
                </div>
            </div>
        </div>

        <div class="modal__foot">
            <!-- Footer STEP 1 -->
            <div id="emailFootStart" style="display:flex;gap:12px;justify-content:flex-end;width:100%">
                <button class="btn" data-close="#modal-email">H·ªßy</button>
                <button class="btn btn--primary" id="saveEmail">G·ª≠i m√£</button>
            </div>
            <!-- Footer STEP 2 -->
            <div id="emailFootVerify" style="display:none;gap:12px;justify-content:flex-end;width:100%">
                <button class="btn" id="cancelEmail">H·ªßy</button>
                <button class="btn" id="resendEmail" disabled>G·ª≠i l·∫°i (60s)</button>
                <button class="btn btn--primary" id="verifyEmail">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>


<div class="modal" id="modal-phone" role="dialog" aria-modal="true" aria-labelledby="title-phone">
    <div class="modal__dialog">
        <div class="modal__head">
            <span id="title-phone">ƒê·ªïi s·ªë ƒëi·ªán tho·∫°i</span>
            <button class="btn" data-close="#modal-phone">‚úï</button>
        </div>
        <div class="modal__body">
            <!-- STEP 1: nh·∫≠p SƒêT -->
            <div id="phoneStepStart" class="form-row">
                <label class="hint" for="inpPhone">S·ªë ƒëi·ªán tho·∫°i m·ªõi</label>
                <input id="inpPhone" type="tel" class="input" placeholder="09xx xxx xxx"/>

                <!-- NEW: current password -->
                <label class="hint" for="inpPhoneCurrPw" style="margin-top:10px">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                <input id="inpPhoneCurrPw" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                <div id="phoneCurrPwErr" class="help"></div>

                <div id="phoneStartErr" class="help"></div>
            </div>

            <!-- STEP 2: x√°c th·ª±c OTP -->
            <div id="phoneStepVerify" style="display:none">
                <div class="form-row" style="margin-top:10px">
                    <label class="hint" for="inpPhoneOtp">Nh·∫≠p m√£ OTP</label>
                    <input id="inpPhoneOtp" class="input" inputmode="numeric" pattern="[0-9]{6}" maxlength="6"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
                    <div class="help" id="phoneOtpStatus"></div>
                </div>
            </div>
        </div>

        <div class="modal__foot">
            <!-- Footer STEP 1 -->
            <div id="phoneFootStart" style="display:flex;gap:12px;justify-content:flex-end;width:100%">
                <button class="btn" data-close="#modal-phone">H·ªßy</button>
                <button class="btn btn--primary" id="sendPhoneCode">G·ª≠i m√£</button>
            </div>
            <!-- Footer STEP 2 -->
            <div id="phoneFootVerify" style="display:none;gap:12px;justify-content:flex-end;width:100%">
                <button class="btn" id="cancelPhone">H·ªßy</button>
                <button class="btn" id="resendPhone" disabled>G·ª≠i l·∫°i (60s)</button>
                <button class="btn btn--primary" id="verifyPhone">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modal-allergens" role="dialog" aria-modal="true" aria-labelledby="title-alls">
    <div class="modal__dialog">
        <div class="modal__head">
            <span id="title-alls">Ch·ªânh s·ª≠a d·ªã ·ª©ng</span>
            <button class="btn" data-close="#modal-allergens">‚úï</button>
        </div>
        <div class="modal__body">
            <div class="chips" id="chipsAll"></div>
            <div class="chip-add">
                <input id="inpAll" class="input" placeholder="Th√™m allergen r·ªìi Enter‚Ä¶"/>
                <button class="btn" id="btnAddAll">Th√™m</button>
            </div>
            <input type="hidden" id="hiddenAllCsv"
                   th:value="${#lists.isEmpty(user.allergens) ? '' : #strings.listJoin(user.allergens, ',')}"/>
            <span class="hint">V√≠ d·ª•: ƒë·∫≠u ph·ªông, c√°‚Ä¶</span>
        </div>
        <div class="modal__foot">
            <button class="btn" data-close="#modal-allergens">H·ªßy</button>
            <button class="btn btn--primary" id="saveAllergens">L∆∞u</button>
        </div>
    </div>
</div>

<!-- Footer -->
<th:block th:replace="~{customer/fragments/footer :: footer}"></th:block>
<th:block th:replace="~{customer/fragments/header :: scripts}"></th:block>
<th:block th:replace="~{customer/fragments/footer :: scripts}"></th:block>

<script>
    (function () {
        // ================== API ENDPOINTS ==================
        const API = {
            name: '/profile/name',
            email: '/profile/email',               // POST {email} -> send OTP | POST {code} -> verify
            emailCancel: '/profile/email/cancel',  // POST {}      -> cancel change
            phone: '/profile/phone',               // POST {phoneNumber} -> send OTP | POST {code} -> verify
            phoneCancel: '/profile/phone/cancel',  // POST {}      -> cancel change
            allergens: '/profile/allergens',
            changePass: '/profile/password'
        };

        // ================== CSRF ==================
        const CSRF = document.getElementById('csrfToken')?.value || '';

        // ================== TOAST ==================
        const toastWrap = document.getElementById('toastWrap');

        function showToast(msg, type = 'success', duration = 5000) {
            const el = document.createElement('div');
            el.className = 'toast ' + (type === 'success' ? 'toast--success' : 'toast--error');
            el.setAttribute('role', type === 'success' ? 'status' : 'alert');
            el.setAttribute('aria-live', type === 'success' ? 'polite' : 'assertive');
            el.innerHTML = `
      <span class="toast__icon" aria-hidden="true">${type === 'success' ? '‚úì' : '‚ö†'}</span>
      <div class="toast__body">${msg}</div>
      <button class="toast__close" aria-label="ƒê√≥ng">√ó</button>
      <div class="toast__progress" style="animation-duration:${duration}ms"></div>
    `;
            toastWrap.appendChild(el);
            const remove = () => {
                el.classList.add('is-hiding');
                setTimeout(() => el.remove(), 200);
            };
            const t = setTimeout(remove, duration);
            el.querySelector('.toast__close').addEventListener('click', () => {
                clearTimeout(t);
                remove();
            });
        }

        // ================== HTTP HELPERS ==================
        async function post(url, data) {
            const body = new URLSearchParams(data || {});
            if (CSRF) body.set('_csrf', CSRF);
            try {
                const r = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRF-TOKEN': CSRF},
                    credentials: 'same-origin',
                    body
                });
                const t = await r.text();
                try {
                    return JSON.parse(t);
                } catch {
                    return {ok: false, message: t || 'Server error'};
                }
            } catch {
                return {ok: false, message: 'Network error'};
            }
        }

        // ================== MODAL HELPERS ==================
        function openModal(sel) {
            document.querySelector(sel)?.classList.add('is-open');
        }

        function closeModal(sel) {
            document.querySelector(sel)?.classList.remove('is-open');
        }

        // Unified close handlers (click backdrop / [data-close] / Esc) ‚Üí cancel email/phone flows if needed
        document.addEventListener('click', async (e) => {
            const closeBtn = e.target.closest('[data-close]');
            if (closeBtn) {
                const sel = closeBtn.getAttribute('data-close');
                await maybeCancelEmail(sel);
                await maybeCancelPhone(sel);
                closeModal(sel);
            }
            if (e.target.classList.contains('modal')) {
                const sel = '#' + e.target.id;
                await maybeCancelEmail(sel);
                await maybeCancelPhone(sel);
                e.target.classList.remove('is-open');
            }
        });
        document.addEventListener('keydown', async (e) => {
            if (e.key === 'Escape') {
                const top = document.querySelector('.modal.is-open');
                if (top) {
                    const sel = '#' + top.id;
                    await maybeCancelEmail(sel);
                    await maybeCancelPhone(sel);
                    top.classList.remove('is-open');
                }
            }
        });

        // ================== BIND VIEW FIELDS ==================
        const valName = document.getElementById('valName');
        const valEmail = document.getElementById('valEmail');
        const valPhone = document.getElementById('valPhone');
        const valAlls = document.getElementById('valAllergens');

        // ================== OPEN MODALS ==================
        document.getElementById('btnName')?.addEventListener('click', () => {
            document.getElementById('inpFullName').value = (valName.textContent || '').trim();
            openModal('#modal-name');
        });
        document.getElementById('btnEmail')?.addEventListener('click', () => {
            document.getElementById('inpEmail').value = (valEmail.textContent || '').trim();
            enterEmailStart();
            openModal('#modal-email');
        });
        document.getElementById('btnPhone')?.addEventListener('click', () => {
            document.getElementById('inpPhone').value = (valPhone.textContent || '').trim();
            enterPhoneStart();
            openModal('#modal-phone');
        });
        document.getElementById('btnAllergens')?.addEventListener('click', () => {
            renderAllergenChips();
            openModal('#modal-allergens');
        });

        // ================== NAME SAVE ==================
        document.getElementById('saveName')?.addEventListener('click', async () => {
            const fullName = document.getElementById('inpFullName').value.trim();
            if (!fullName) return;
            const res = await post(API.name, {fullName});
            if (res.ok) {
                valName.textContent = res.value || fullName;
                showToast('ƒê√£ c·∫≠p nh·∫≠t t√™n hi·ªÉn th·ªã');
                closeModal('#modal-name');
            } else {
                showToast(res.message || 'Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c t√™n', 'error');
            }
        });

        // ================== ALLERGENS CHIP EDITOR ==================
        const chipsWrap = document.getElementById('chipsAll');
        const inpAll = document.getElementById('inpAll');
        const btnAddAll = document.getElementById('btnAddAll');
        const hiddenCsv = document.getElementById('hiddenAllCsv');

        function allList() {
            return hiddenCsv.value ? hiddenCsv.value.split(',').map(s => s.trim()).filter(Boolean) : [];
        }

        function allWrite(arr) {
            hiddenCsv.value = arr.join(',');
        }

        function renderAllergenChips() {
            if (!chipsWrap) return;
            chipsWrap.innerHTML = '';
            allList().forEach(val => {
                const chip = document.createElement('span');
                chip.className = 'chip';
                const text = document.createElement('span');
                text.textContent = val;
                const rm = document.createElement('button');
                rm.type = 'button';
                rm.textContent = '√ó';
                rm.onclick = () => {
                    allWrite(allList().filter(x => x !== val));
                    renderAllergenChips();
                };
                chip.append(text, rm);
                chipsWrap.appendChild(chip);
            });
        }

        function addAllergen(v) {
            v = (v || '').trim();
            if (!v) return;
            const set = new Set(allList());
            set.add(v);
            allWrite([...set]);
            renderAllergenChips();
            if (inpAll) inpAll.value = '';
        }

        btnAddAll?.addEventListener('click', () => addAllergen(inpAll.value));
        inpAll?.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addAllergen(inpAll.value);
            }
        });
        document.getElementById('saveAllergens')?.addEventListener('click', async () => {
            const allergensCsv = hiddenCsv.value;
            const res = await post(API.allergens, {allergensCsv});
            if (res.ok) {
                valAlls.textContent = res.value || (allergensCsv ? allergensCsv.split(',').join(', ') : '‚Äî');
                showToast('ƒê√£ c·∫≠p nh·∫≠t allergens');
                closeModal('#modal-allergens');
            } else {
                showToast(res.message || 'Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c allergens', 'error');
            }
        });

        // ================== EMAIL CHANGE (2-STEP OTP) ==================
        const emailStepStart = document.getElementById('emailStepStart');
        const emailFootStart = document.getElementById('emailFootStart');
        const emailStepVerify = document.getElementById('emailStepVerify');
        const emailFootVerify = document.getElementById('emailFootVerify');

        const inpEmail = document.getElementById('inpEmail');
        const inpEmailCurrPw = document.getElementById('inpEmailCurrPw');   // NEW
        const emailCurrPwErr = document.getElementById('emailCurrPwErr');   // NEW
        const emailStartErr = document.getElementById('emailStartErr');
        const saveEmailBtn = document.getElementById('saveEmail');

        const inpEmailOtp = document.getElementById('inpEmailOtp');
        const emailOtpStatus = document.getElementById('emailOtpStatus');
        const resendEmailBtn = document.getElementById('resendEmail');
        const verifyEmailBtn = document.getElementById('verifyEmail');
        const cancelEmailBtn = document.getElementById('cancelEmail');

        let emailState = 'IDLE';   // 'IDLE' | 'VERIFY'
        let pendingEmail = null;
        let timerEmail = null, leftEmail = 0;

        function clearEmailCooldown() {
            clearInterval(timerEmail);
            timerEmail = null;
        }

        function startEmailCooldown(seconds) {
            if (!resendEmailBtn) return;
            clearEmailCooldown();
            leftEmail = Number(seconds || 60);
            resendEmailBtn.disabled = true;
            resendEmailBtn.textContent = `G·ª≠i l·∫°i (${leftEmail}s)`;
            timerEmail = setInterval(() => {
                leftEmail--;
                resendEmailBtn.textContent = `G·ª≠i l·∫°i (${leftEmail}s)`;
                if (leftEmail <= 0) {
                    clearEmailCooldown();
                    resendEmailBtn.disabled = false;
                    resendEmailBtn.textContent = 'G·ª≠i l·∫°i';
                }
            }, 1000);
        }

        function setEmailCurrPwError(msg) {
            if (!emailCurrPwErr || !inpEmailCurrPw) return;
            emailCurrPwErr.textContent = msg || '';
            emailCurrPwErr.className = 'help' + (msg ? ' help-err' : '');
            inpEmailCurrPw.classList.toggle('input--error', !!msg);
        }

        function setStartError(msg) {
            if (!emailStartErr || !inpEmail) return;
            emailStartErr.textContent = msg || '';
            emailStartErr.className = 'help' + (msg ? ' help-err' : '');
            inpEmail.classList.toggle('input--error', !!msg);
        }

        function setVerifyStatus(msg, ok) {
            if (!emailOtpStatus) return;
            emailOtpStatus.textContent = msg || '';
            emailOtpStatus.className = 'help' + (msg ? (ok ? ' help-ok' : ' help-err') : '');
        }

        function enterEmailStart() {
            emailState = 'IDLE';
            if (emailStepStart) emailStepStart.style.display = '';
            if (emailFootStart) emailFootStart.style.display = 'flex';
            if (emailStepVerify) emailStepVerify.style.display = 'none';
            if (emailFootVerify) emailFootVerify.style.display = 'none';
            setStartError('');
            setVerifyStatus('', true);
            clearEmailCooldown();
            inpEmail?.focus();
        }

        function enterEmailVerify(retryAfter) {
            emailState = 'VERIFY';
            if (emailStepStart) emailStepStart.style.display = 'none';
            if (emailFootStart) emailFootStart.style.display = 'none';
            if (emailStepVerify) emailStepVerify.style.display = '';
            if (emailFootVerify) emailFootVerify.style.display = 'flex';
            setVerifyStatus('ƒê√£ g·ª≠i m√£ OTP. Vui l√≤ng ki·ªÉm tra email.', true);
            startEmailCooldown(Number(retryAfter || 60));
            inpEmailOtp?.focus();
        }

        async function maybeCancelEmail(sel) {
            if (sel === '#modal-email' && emailState === 'VERIFY') {
                await post(API.emailCancel, {});
                enterEmailStart();
            }
        }

        // START: g·ª≠i m√£ t·ªõi email m·ªõi
        saveEmailBtn?.addEventListener('click', async () => {
            const email = (inpEmail?.value || '').trim();
            const currentPassword = (inpEmailCurrPw?.value || '').trim();     // NEW
            setEmailCurrPwError('');                                          // NEW

            if (!email) {
                setStartError('Vui l√≤ng nh·∫≠p email.');
                return;
            }
            if (!currentPassword) {                                            // NEW
                setEmailCurrPwError('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i.');
                return;
            }

            setStartError('');
            const res = await post(API.email, {email, currentPassword});    // NEW: g·ª≠i k√®m
            if (res.ok && res.step === 'VERIFY') {
                pendingEmail = email;
                enterEmailVerify(Number(res.retryAfter));
            } else {
                // n·∫øu backend tr·∫£ l·ªói ‚Äúm·∫≠t kh·∫©u‚Ä¶‚Äù th√¨ show ƒë√∫ng field
                if ((res.message || '').toLowerCase().includes('m·∫≠t kh·∫©u')) {
                    setEmailCurrPwError(res.message);
                } else {
                    setStartError(res.message || 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c m√£. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            }
        });

        // VERIFY
        verifyEmailBtn?.addEventListener('click', async () => {
            const code = (inpEmailOtp?.value || '').trim();
            if (!/^\d{6}$/.test(code)) {
                setVerifyStatus('M√£ OTP kh√¥ng h·ª£p l·ªá.', false);
                return;
            }
            const res = await post(API.email, {code});
            if (res.ok) {
                valEmail.textContent = res.value || pendingEmail || valEmail.textContent;
                showToast('ƒê√£ ƒë·ªïi email th√†nh c√¥ng');
                pendingEmail = null;
                enterEmailStart();
                closeModal('#modal-email');
            } else {
                setVerifyStatus(res.message || 'M√£ OTP kh√¥ng ƒë√∫ng.', false);
            }
        });

        // RESEND
        resendEmailBtn?.addEventListener('click', async () => {
            if (!pendingEmail) return;
            const res = await post(API.email, {email: pendingEmail});
            if (res.ok) {
                setVerifyStatus('ƒê√£ g·ª≠i l·∫°i m√£ OTP.', true);
                startEmailCooldown(Number(res.retryAfter || 60));
            } else {
                setVerifyStatus(res.message || 'Kh√¥ng g·ª≠i l·∫°i ƒë∆∞·ª£c m√£.', false);
                if (res.retryAfter) startEmailCooldown(Number(res.retryAfter));
            }
        });

        // CANCEL
        cancelEmailBtn?.addEventListener('click', async () => {
            await post(API.emailCancel, {});
            enterEmailStart();
            closeModal('#modal-email');
        });

        // ================== PHONE CHANGE (2-STEP OTP) ==================
        const phoneStepStart = document.getElementById('phoneStepStart');
        const phoneFootStart = document.getElementById('phoneFootStart');
        const phoneStepVerify = document.getElementById('phoneStepVerify');
        const phoneFootVerify = document.getElementById('phoneFootVerify');

        const inpPhone = document.getElementById('inpPhone');
        const inpPhoneCurrPw = document.getElementById('inpPhoneCurrPw');   // NEW
        const phoneCurrPwErr = document.getElementById('phoneCurrPwErr');   // NEW
        const phoneStartErr = document.getElementById('phoneStartErr');
        const sendPhoneCode = document.getElementById('sendPhoneCode');

        const inpPhoneOtp = document.getElementById('inpPhoneOtp');
        const phoneOtpStatus = document.getElementById('phoneOtpStatus');
        const resendPhoneBtn = document.getElementById('resendPhone');
        const verifyPhoneBtn = document.getElementById('verifyPhone');
        const cancelPhoneBtn = document.getElementById('cancelPhone');

        let phoneState = 'IDLE'; // 'IDLE' | 'VERIFY'
        let pendingPhone = null;
        let timerPhone = null, leftPhone = 0;

        function startPhoneCooldown(sec) {
            if (!resendPhoneBtn) return;
            clearInterval(timerPhone);
            leftPhone = Number(sec || 60);
            resendPhoneBtn.disabled = true;
            resendPhoneBtn.textContent = `G·ª≠i l·∫°i (${leftPhone}s)`;
            timerPhone = setInterval(() => {
                leftPhone--;
                resendPhoneBtn.textContent = `G·ª≠i l·∫°i (${leftPhone}s)`;
                if (leftPhone <= 0) {
                    clearInterval(timerPhone);
                    resendPhoneBtn.disabled = false;
                    resendPhoneBtn.textContent = 'G·ª≠i l·∫°i';
                }
            }, 1000);
        }

        function setPhoneCurrPwError(msg) {
            if (!phoneCurrPwErr || !inpPhoneCurrPw) return;
            phoneCurrPwErr.textContent = msg || '';
            phoneCurrPwErr.className = 'help' + (msg ? ' help-err' : '');
            inpPhoneCurrPw.classList.toggle('input--error', !!msg);
        }

        function setPhoneStartError(msg) {
            if (!phoneStartErr || !inpPhone) return;
            phoneStartErr.textContent = msg || '';
            phoneStartErr.className = 'help' + (msg ? ' help-err' : '');
            inpPhone.classList.toggle('input--error', !!msg);
        }

        function setPhoneVerifyStatus(msg, ok) {
            if (!phoneOtpStatus) return;
            phoneOtpStatus.textContent = msg || '';
            phoneOtpStatus.className = 'help' + (msg ? (ok ? ' help-ok' : ' help-err') : '');
        }

        function enterPhoneStart() {
            phoneState = 'IDLE';
            if (phoneStepStart) phoneStepStart.style.display = '';
            if (phoneFootStart) phoneFootStart.style.display = 'flex';
            if (phoneStepVerify) phoneStepVerify.style.display = 'none';
            if (phoneFootVerify) phoneFootVerify.style.display = 'none';
            setPhoneStartError('');
            setPhoneVerifyStatus('', true);
            clearInterval(timerPhone);
            inpPhone?.focus();
        }

        function enterPhoneVerify(retryAfter) {
            phoneState = 'VERIFY';
            if (phoneStepStart) phoneStepStart.style.display = 'none';
            if (phoneFootStart) phoneFootStart.style.display = 'none';
            if (phoneStepVerify) phoneStepVerify.style.display = '';
            if (phoneFootVerify) phoneFootVerify.style.display = 'flex';
            setPhoneVerifyStatus('ƒê√£ g·ª≠i m√£ OTP. Vui l√≤ng ki·ªÉm tra tin nh·∫Øn.', true);
            startPhoneCooldown(Number(retryAfter || 60));
            inpPhoneOtp?.focus();
        }

        async function maybeCancelPhone(sel) {
            if (sel === '#modal-phone' && phoneState === 'VERIFY') {
                await post(API.phoneCancel, {});
                enterPhoneStart();
            }
        }

        // START
        sendPhoneCode?.addEventListener('click', async () => {
            const phoneNumber = (inpPhone?.value || '').trim();
            const currentPassword = (inpPhoneCurrPw?.value || '').trim();    // NEW
            setPhoneCurrPwError('');                                         // NEW

            if (!phoneNumber) {
                setPhoneStartError('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.');
                return;
            }
            if (!currentPassword) {                                           // NEW
                setPhoneCurrPwError('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i.');
                return;
            }

            setPhoneStartError('');
            const res = await post(API.phone, {phoneNumber, currentPassword}); // NEW
            if (res.ok && res.step === 'VERIFY') {
                pendingPhone = phoneNumber;
                enterPhoneVerify(Number(res.retryAfter));
            } else {
                if ((res.message || '').toLowerCase().includes('m·∫≠t kh·∫©u')) {
                    setPhoneCurrPwError(res.message);
                } else {
                    setPhoneStartError(res.message || 'Kh√¥ng g·ª≠i ƒë∆∞·ª£c m√£. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            }
        });


        // VERIFY
        verifyPhoneBtn?.addEventListener('click', async () => {
            const code = (inpPhoneOtp?.value || '').trim();
            if (!/^\d{6}$/.test(code)) {
                setPhoneVerifyStatus('M√£ OTP kh√¥ng h·ª£p l·ªá.', false);
                return;
            }
            const res = await post(API.phone, {code});
            if (res.ok) {
                valPhone.textContent = res.value || pendingPhone || valPhone.textContent;
                showToast('ƒê√£ ƒë·ªïi s·ªë ƒëi·ªán tho·∫°i th√†nh c√¥ng');
                pendingPhone = null;
                enterPhoneStart();
                closeModal('#modal-phone');
            } else {
                setPhoneVerifyStatus(res.message || 'M√£ OTP kh√¥ng ƒë√∫ng.', false);
            }
        });

        // RESEND
        resendPhoneBtn?.addEventListener('click', async () => {
            if (!pendingPhone) return;
            const res = await post(API.phone, {phoneNumber: pendingPhone});
            if (res.ok) {
                setPhoneVerifyStatus('ƒê√£ g·ª≠i l·∫°i m√£ OTP.', true);
                startPhoneCooldown(Number(res.retryAfter || 60));
            } else {
                setPhoneVerifyStatus(res.message || 'Kh√¥ng g·ª≠i l·∫°i ƒë∆∞·ª£c m√£.', false);
                if (res.retryAfter) startPhoneCooldown(Number(res.retryAfter));
            }
        });

        // CANCEL
        cancelPhoneBtn?.addEventListener('click', async () => {
            await post(API.phoneCancel, {});
            enterPhoneStart();
            closeModal('#modal-phone');
        });

        // ================== CHANGE PASSWORD (API) ==================
        const formPass = document.getElementById('formChangePass');
        if (formPass) {
            const curr = document.getElementById('currPass');
            const npw = document.getElementById('newPass');
            const conf = document.getElementById('confirmPass');
            const errCurr = document.getElementById('errCurr');
            const errNew = document.getElementById('errNew');
            const errConf = document.getElementById('errConfirm');

            function clearErrors() {
                [curr, npw, conf].forEach(i => i?.classList.remove('input--error'));
                [errCurr, errNew, errConf].forEach(e => {
                    if (e) {
                        e.textContent = '';
                        e.className = 'help';
                    }
                });
            }

            function setFieldError(input, errEl, msg) {
                if (!msg || !input || !errEl) return;
                input.classList.add('input--error');
                errEl.textContent = msg;
                errEl.className = 'help help-err';
            }

            formPass.addEventListener('submit', async (e) => {
                e.preventDefault();
                clearErrors();

                const payload = {
                    currentPassword: curr?.value.trim(),
                    newPassword: npw?.value.trim(),
                    confirmPassword: conf?.value.trim()
                };

                const res = await post(API.changePass, payload);

                if (res.ok) {
                    formPass.reset();
                    showToast(res.message || 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng');
                    return;
                }
                if (res.errors) {
                    setFieldError(curr, errCurr, res.errors.currentPassword);
                    setFieldError(npw, errNew, res.errors.newPassword);
                    setFieldError(conf, errConf, res.errors.confirmPassword);
                }
                if (res.message) {
                    showToast('L·ªói: ' + res.message, 'error');
                } else if (res.messages && res.messages.length) {
                    showToast(res.messages.join('\n'), 'error');
                } else {
                    showToast('Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
                }
            });
        }
    })();
</script>

<script>
    (function () {
        const form = document.getElementById('formChangePass');
        if (!form) return;

        const curr = document.getElementById('currPass');
        const npw = document.getElementById('newPass');
        const conf = document.getElementById('confirmPass');
        const btnGo = document.getElementById('btnChangePass');

        const errCurr = document.getElementById('errCurr');
        const errNew = document.getElementById('errNew');
        const errConf = document.getElementById('errConfirm');

        const capCurr = document.getElementById('capCurr');
        const meter = document.getElementById('pwMeter');
        const label = document.getElementById('pwLabel');

        // --- CapsLock hint (tr∆∞·ªùng current) ---
        function bindCaps(el, hintEl) {
            if (!el || !hintEl) return;
            const show = (on) => {
                hintEl.textContent = on ? 'Caps Lock ƒëang b·∫≠t' : '';
                hintEl.className = on ? 'help help-caps' : 'help';
            };
            el.addEventListener('keyup', e => show(e.getModifierState && e.getModifierState('CapsLock')));
            el.addEventListener('keydown', e => show(e.getModifierState && e.getModifierState('CapsLock')));
            el.addEventListener('blur', () => show(false));
        }

        bindCaps(curr, capCurr);

        // --- Strength meter ---
        function score(pw) {
            if (!pw) return 0;
            let s = 0;
            if (pw.length >= 7) s++;
            if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) s++;
            if (/\d/.test(pw)) s++;
            if (/[^A-Za-z0-9]/.test(pw)) s++;
            return Math.min(4, s);
        }

        function renderMeter(n) {
            if (!meter || !label) return;
            const bars = meter.querySelectorAll('.pw-bar');
            bars.forEach((b, i) => {
                b.className = 'pw-bar';
                if (i < n) b.className = 'pw-bar is-active level-' + n;
            });
            label.textContent = 'ƒê·ªô m·∫°nh: ' + (['‚Äî', 'Y·∫øu', 'Trung b√¨nh', 'Kh√°', 'M·∫°nh'][n] || '‚Äî');
        }

        // --- Ch·ªâ hi·ªán l·ªói khi ƒë√£ t∆∞∆°ng t√°c ho·∫∑c sau khi submit ---
        const touched = {curr: false, npw: false, conf: false};
        let attempted = false;

        function setErr(el, msg) {
            if (!el) return;
            el.textContent = msg || '';
            el.className = msg ? 'help help-err' : 'help';
        }

        function validate() {
            const c = curr.value.trim();
            const n = npw.value.trim();
            const f = conf.value.trim();

            // reset CSS
            [curr, npw, conf].forEach(i => i.classList.remove('input--error'));

            // meter
            renderMeter(score(n));

            // ƒëi·ªÅu ki·ªán h·ª£p l·ªá th·ª±c t·∫ø (ƒë·ªÉ b·∫≠t n√∫t)
            const okForm =
                c.length > 0 &&
                n.length >= 7 &&
                n !== c &&
                f.length > 0 &&
                n === f;

            btnGo.disabled = !okForm;

            // ch·ªâ render l·ªói khi field ƒë√£ "touched" ho·∫∑c user ƒë√£ ·∫•n submit
            const show = (key) => attempted || touched[key];

            if (show('curr') && !c) {
                setErr(errCurr, 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i');
                curr.classList.add('input--error');
            } else setErr(errCurr, '');

            if (show('npw')) {
                if (n.length < 7) {
                    setErr(errNew, 'M·∫≠t kh·∫©u m·ªõi t·ªëi thi·ªÉu 7 k√Ω t·ª±');
                    npw.classList.add('input--error');
                } else if (n === c) {
                    setErr(errNew, 'M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c tr√πng m·∫≠t kh·∫©u hi·ªán t·∫°i');
                    npw.classList.add('input--error');
                } else setErr(errNew, '');
            } else setErr(errNew, '');

            if (show('conf')) {
                if (!f) {
                    setErr(errConf, 'Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u');
                    conf.classList.add('input--error');
                } else if (n !== f) {
                    setErr(errConf, 'X√°c nh·∫≠n kh√¥ng kh·ªõp');
                    conf.classList.add('input--error');
                } else setErr(errConf, '');
            } else setErr(errConf, '');
        }

        // ƒë√°nh d·∫•u touched khi ng∆∞·ªùi d√πng thao t√°c
        curr.addEventListener('input', () => {
            touched.curr = true;
            validate();
        });
        npw.addEventListener('input', () => {
            touched.npw = true;
            validate();
        });
        conf.addEventListener('input', () => {
            touched.conf = true;
            validate();
        });

        curr.addEventListener('blur', () => {
            touched.curr = true;
            validate();
        });
        npw.addEventListener('blur', () => {
            touched.npw = true;
            validate();
        });
        conf.addEventListener('blur', () => {
            touched.conf = true;
            validate();
        });

        // khi b·∫•m submit (tr∆∞·ªõc handler API), b·∫Øt ƒë·∫ßu show t·∫•t c·∫£ l·ªói n·∫øu c√≥
        form.addEventListener('submit', () => {
            attempted = true;
            validate();
        }, true);

        // init: KH√îNG show l·ªói, ch·ªâ meter & disable n√∫t
        renderMeter(0);
        validate();
    })();
</script>
</body>
</html>
